name: Publish NuGet packages

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: windows-latest
    environment: nuget-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore
        run: dotnet restore src/DbSqlLikeMem.slnx

      - name: Pack
        run: dotnet pack src/DbSqlLikeMem.slnx -c Release -o ./artifacts

      - name: Validate package repository metadata
        shell: bash
        run: |
          python - <<'PYCODE'
          import glob
          import os
          import zipfile
          import xml.etree.ElementTree as ET

          def get_child(parent, local_name):
              for child in parent:
                  tag = child.tag.split('}', 1)[-1] if '}' in child.tag else child.tag
                  if tag == local_name:
                      return child

              return None

          packages = glob.glob('./artifacts/*.nupkg')
          packages = [p for p in packages if 'DbSqlLikeMem.VisualStudioExtension.' not in os.path.basename(p)]

          if not packages:
              raise SystemExit('::error::No publishable packages found for metadata validation.')

          for package in packages:
              with zipfile.ZipFile(package) as zf:
                  nuspec_name = next((n for n in zf.namelist() if n.endswith('.nuspec')), None)
                  if not nuspec_name:
                      raise SystemExit(f'::error::{os.path.basename(package)} does not contain a .nuspec file.')

                  with zf.open(nuspec_name) as nuspec:
                      root = ET.parse(nuspec).getroot()

              metadata = get_child(root, 'metadata')
              if metadata is None:
                  raise SystemExit(f'::error::{os.path.basename(package)} has no metadata section in nuspec.')

              repository = get_child(metadata, 'repository')
              repo_url = repository.attrib.get('url') if repository is not None else None
              if not repo_url or 'github.com/christianulson/DbSqlLikeMem' not in repo_url:
                  raise SystemExit(f'::error::{os.path.basename(package)} is missing expected repository URL metadata.')

              print(f'Validated repository metadata: {os.path.basename(package)} -> {repo_url}')
          PYCODE

      - name: Validate NuGet API key (NUGET_API_KEY)
        shell: bash
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          if [ -z "$NUGET_API_KEY" ]; then
            echo "::error::NUGET_API_KEY is empty or unavailable in Environment 'nuget-publish'."
            echo "::error::Confirm the workflow run is using Environment 'nuget-publish' and that its protection rules allow this run."
            exit 1
          fi

          echo "NUGET_API_KEY is configured."

      - name: Publish to NuGet.org
        shell: bash
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          shopt -s nullglob
          packages=(./artifacts/*.nupkg)
          publish_packages=()

          for package in "${packages[@]}"; do
            package_name="$(basename "$package")"

            if [[ "$package_name" == DbSqlLikeMem.VisualStudioExtension.*.nupkg ]]; then
              echo "Skipping Visual Studio extension package: $package_name"
              continue
            fi

            publish_packages+=("$package")
          done

          if [ -z "$NUGET_API_KEY" ]; then
            echo "::error::NUGET_API_KEY is empty at publish step."
            exit 1
          fi

          if [ ${#packages[@]} -eq 0 ]; then
            echo "::error::No packages were found in ./artifacts."
            exit 1
          fi

          if [ ${#publish_packages[@]} -eq 0 ]; then
            echo "::error::No publishable NuGet packages were found after exclusions."
            exit 1
          fi

          for package in "${publish_packages[@]}"; do
            echo "Publishing $(basename "$package") to NuGet.org"
            dotnet nuget push "$package" --api-key "$NUGET_API_KEY" --source "https://api.nuget.org/v3/index.json" --skip-duplicate
          done

      - name: Publish symbols to NuGet.org
        shell: bash
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          shopt -s nullglob
          symbols=(./artifacts/*.snupkg)

          if [ ${#symbols[@]} -eq 0 ]; then
            echo "No symbol packages (.snupkg) found to publish."
            exit 0
          fi

          for symbol in "${symbols[@]}"; do
            symbol_name="$(basename "$symbol")"
            if [[ "$symbol_name" == DbSqlLikeMem.VisualStudioExtension.*.snupkg ]]; then
              echo "Skipping Visual Studio extension symbol package: $symbol_name"
              continue
            fi

            echo "Publishing symbols $symbol_name to NuGet.org"
            dotnet nuget push "$symbol" --api-key "$NUGET_API_KEY" --source "https://api.nuget.org/v3/index.json" --skip-duplicate
          done
